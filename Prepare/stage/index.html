<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Prepare/stage">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">Stage | IBM Client Engineering</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://ibm-client-engineering.github.io/solution-sfg-aws/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://ibm-client-engineering.github.io/solution-sfg-aws/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://ibm-client-engineering.github.io/solution-sfg-aws/Prepare/stage"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="keywords" content="ibm client engineering, open solutions library,  sfg, eks, aws, cp4ba, sfg on aws eks"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Stage | IBM Client Engineering"><meta data-rh="true" name="description" content="Software"><meta data-rh="true" property="og:description" content="Software"><link data-rh="true" rel="icon" href="/solution-sfg-aws/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ibm-client-engineering.github.io/solution-sfg-aws/Prepare/stage"><link data-rh="true" rel="alternate" href="https://ibm-client-engineering.github.io/solution-sfg-aws/Prepare/stage" hreflang="en"><link data-rh="true" rel="alternate" href="https://ibm-client-engineering.github.io/solution-sfg-aws/Prepare/stage" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/solution-sfg-aws/blog/rss.xml" title="IBM Client Engineering RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/solution-sfg-aws/blog/atom.xml" title="IBM Client Engineering Atom Feed">






<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GB0XWXF3GE"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-GB0XWXF3GE",{anonymize_ip:!0})</script><link rel="stylesheet" href="/solution-sfg-aws/assets/css/styles.c09cc6e1.css">
<link rel="preload" href="/solution-sfg-aws/assets/js/runtime~main.4e782439.js" as="script">
<link rel="preload" href="/solution-sfg-aws/assets/js/main.0cd2a445.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/solution-sfg-aws/"><div class="navbar__logo"><img src="/solution-sfg-aws/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA" height="200" width="200"><img src="/solution-sfg-aws/img/logo-dark.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU" height="200" width="200"></div><b class="navbar__title text--truncate">| IBM Sterling File Gateway on AWS EKS</b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/solution-sfg-aws/">Flight Path</a><a class="navbar__item navbar__link" href="/solution-sfg-aws/blog">Flight Logs</a><a href="https://github.com/ibm-client-engineering/solution-sfg-aws" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/solution-sfg-aws/">Flight Path</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="true" href="/solution-sfg-aws/category/innovate">Innovate</a><button aria-label="Toggle the collapsible sidebar category &#x27;Innovate&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/solution-sfg-aws/Innovate/intro">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/solution-sfg-aws/Innovate/refine">Refine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/solution-sfg-aws/Innovate/solution-design">Architecture</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/solution-sfg-aws/category/prepare">Prepare</a><button aria-label="Toggle the collapsible sidebar category &#x27;Prepare&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/solution-sfg-aws/Prepare/learn">Learn</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/solution-sfg-aws/Prepare/organize">Organize</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/solution-sfg-aws/Prepare/stage">Stage</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/solution-sfg-aws/category/manage">Manage</a><button aria-label="Toggle the collapsible sidebar category &#x27;Manage&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="true" href="/solution-sfg-aws/category/create">Create</a><button aria-label="Toggle the collapsible sidebar category &#x27;Create&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/solution-sfg-aws/Create/solution-deploy">Deploy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/solution-sfg-aws/Create/solution-validate">Validate</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/solution-sfg-aws/Create/solution-integrate">Integrate</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/solution-sfg-aws/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/solution-sfg-aws/category/prepare"><span itemprop="name">Prepare</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Stage</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Stage</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="software">Software<a href="#software" class="hash-link" aria-label="Direct link to Software" title="Direct link to Software">​</a></h2><ul><li><p>Generic Requirements:</p><ul><li>Amazon Web Services (AWS) account with necessary permissions</li><li>Access to IBM B2Bi and Sterling File Gateway Enterprise Edition installation packages</li><li>Basic knowledge of Helm, Kubernetes, and Amazon EKS</li><li>Amazon EKS cluster up and running</li><li>Helm CLI installed on the local machine</li></ul></li></ul><ul><li>Hardware<ul><li>EKS<ul><li><code>m5.xlarge</code> and region as <code>us-east-1</code>. (this has 4 vcpu and 16 gigs ram)</li><li>Default storage class defined</li></ul></li><li>Jump Server/Bastion Host for staging requirements</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="helm-chart-installations">Helm Chart installations<a href="#helm-chart-installations" class="hash-link" aria-label="Direct link to Helm Chart installations" title="Direct link to Helm Chart installations">​</a></h2><p>Install the following two helm repos as they will be required:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">helm repo add ibm-helm https://raw.githubusercontent.com/IBM/charts/master/repo/ibm-helm</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">helm repo add ibm-messaging-mq https://ibm-messaging.github.io/mq-helm</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>Download the latest Sterling helm charts for B2Bi from this link. (Currently 2.1.3 as of this writing)</p><p>Charts: <a href="https://github.com/IBM/charts/blob/master/repo/ibm-helm/ibm-sfg-prod.md" target="_blank" rel="noopener noreferrer">https://github.com/IBM/charts/blob/master/repo/ibm-helm/ibm-sfg-prod.md</a></p><p><a href="https://github.com/IBM/charts/blob/master/repo/ibm-helm/ibm-b2bi-prod-2.1.3.tgz" target="_blank" rel="noopener noreferrer">ibm-b2bi-prod-2.1.3</a></p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="aws-account">AWS Account<a href="#aws-account" class="hash-link" aria-label="Direct link to AWS Account" title="Direct link to AWS Account">​</a></h2><p>In this section we will setup up you setup your AWS command line and credentials.</p><p>You can run a curl command to install the AWS CLI or you can go to <a href="https://awscli.amazonaws.com/AWSCLIV2.pkg" target="_blank" rel="noopener noreferrer">https://awscli.amazonaws.com/AWSCLIV2.pkg</a> and setup the AWS CLI using GUI installer. We will be using Mac OS in this documentation, but you can find specific instruction for you OS here: <a href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html" target="_blank" rel="noopener noreferrer">https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html</a>. The following steps will demonstrate how to setup the AWS CLI through the Mac CLI. </p><p>Download the AWS CLI Client using curl. We can use the -o flag to set the output file name. In this case we set it to &quot;AWSCLIV2.pkg&quot;</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">curl &quot;https://awscli.amazonaws.com/AWSCLIV2.pkg&quot; -o &quot;AWSCLIV2.pkg&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Next, we need to install the file we just got from the curl command. We can run the following command to install. Install it with sudo (to use for all users). The installer command is command-line tool on macOS used to install software packages. The -pkg flag specifies the package file to be installed. In this case, the package file is &quot;AWSCLIV2.pkg,&quot; which should be located in the current directory (&quot;./&quot;). Last the -target option specifies the destination location for the installation. In this case, the forward slash (&quot;/&quot;) indicates that the installation should be performed in the root directory of the macOS system.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">sudo installer -pkg ./AWSCLIV2.pkg -target /</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now that the AWS CLI is installed, let&#x27;s configure our client. We can do that by running the following command. </p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">aws configure</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The command will prompt you for your AWS Access Key ID, AWS Secret Access Key, Default Region, and Default Format. If you are unsure what your Access Key and Key ID are, you can generate new keys from the AWS console. Within the console, go to Identity and Access Management (IAM). Within the IAM dashboard, there should be a section called &quot;Manage Access Keys&quot;. Here you can create and manage your AWS access keys. If you generate a new ID and Key, remember the Key will only be displayed once. Make sure to take note of it before proceeding with the key creation.  If you already have a profile configured, you can add a named profile to your credentials</p><p>If you need to edit you profile, you can use an editor and make changes. With AWS CLI, your configurations are in two files: ~/.aws/credentials and ~/.aws/config. </p><p>Lastly, we are not limited to one profile. We can have multiple users, keys, and configurations (if needed). The following shows our configuration files with two profiles. </p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">vi </span><span class="token operator" style="color:#d7deea">~</span><span class="token operator" style="color:#d7deea">/</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">aws</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">credentials</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">[</span><span class="token keyword" style="color:#c5a5c5">default</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">aws_access_key_id </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">aws_secret_access_key </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">[</span><span class="token tag punctuation" style="color:#8dc891">&lt;</span><span class="token tag class-name" style="color:#FAC863">ACCOUNTID</span><span class="token tag punctuation" style="color:#8dc891">&gt;</span><span class="token plain-text">_AWSAdmin]</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain-text">aws_access_key_id=</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain-text">aws_secret_access_key=</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Also add location info to the config file</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">vi </span><span class="token operator" style="color:#d7deea">~</span><span class="token operator" style="color:#d7deea">/</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">aws</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">config</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">[</span><span class="token keyword" style="color:#c5a5c5">default</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">region </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> us</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">east</span><span class="token operator" style="color:#d7deea">-</span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">output </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> json</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">[</span><span class="token plain">profile techzone_user</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">region</span><span class="token operator" style="color:#d7deea">=</span><span class="token plain">us</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">east</span><span class="token operator" style="color:#d7deea">-</span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">output</span><span class="token operator" style="color:#d7deea">=</span><span class="token plain">json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now that we have our AWS CLI configured, we can select which profile to use by using the following command. </p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">export AWS_PROFILE=&lt;ACCOUNTID&gt;_AWSAdmin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You may also copy the following out of the aws portal and paste it into your shell</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">export AWS_ACCESS_KEY_ID=&quot;&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">export AWS_SECRET_ACCESS_KEY=&quot;&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="aws-vpc-and-eks-cluster">AWS VPC and EKS Cluster<a href="#aws-vpc-and-eks-cluster" class="hash-link" aria-label="Direct link to AWS VPC and EKS Cluster" title="Direct link to AWS VPC and EKS Cluster">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="installing-or-updating-eksctl">Installing or updating <code>eksctl</code><a href="#installing-or-updating-eksctl" class="hash-link" aria-label="Direct link to installing-or-updating-eksctl" title="Direct link to installing-or-updating-eksctl">​</a></h3><p>The <code>eksctl</code> command is a command-line tool used to create, manage, and operate Amazon Elastic Kubernetes Service (Amazon EKS) clusters. It simplifies the process of creating and managing Kubernetes clusters on AWS. </p><p>We can install this tool using homebrew on MacOS. Homebrew, also known as Brew, is a package manager for macOS. It allows you to easily install, manage, and update various software packages and libraries on your Mac. </p><p>The <code>eksctl</code> tool that we need is in the Weaveworks repository and is not part of the &quot;core&quot; packages included in Homebrew. So, we will use a Homebrew tap to add the repository to our local Homebrew. Taps allow you to extend the range of available software packages beyond what is included in the main Homebrew repository.</p><p>The following <code>brew</code> commands will add Weaveworks to our local Homebrew and then install the <code>eksctl</code> tool from it.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">brew tap weaveworks/tap</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">brew install weaveworks/tap/eksctl</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>We are going to create an IAM user with admin privs to create and own this whole cluster.</strong></p><p>In the web management UI for AWS, go to IAM settings and create a user with admin privileges but no management console access. We created a user called &quot;K8-Admin&quot;</p><p>Delete or rename your <code>~/.aws/credentials</code> file and re-run <code>aws configure</code> with the new user&#x27;s Access and secret access keys.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploying-a-cluster-with-eksctl">Deploying a cluster with <code>eksctl</code><a href="#deploying-a-cluster-with-eksctl" class="hash-link" aria-label="Direct link to deploying-a-cluster-with-eksctl" title="Direct link to deploying-a-cluster-with-eksctl">​</a></h3><p>Run the <code>eksctl</code> command below to create your first cluster and perform the following:</p><ul><li>Create a 3-node Kubernetes cluster named <code>sterling-east</code> with one node type as <code>m5.xlarge</code> and region as <code>us-east-1</code>.</li><li>Define a minimum of one node (<code>--nodes-min 1</code>) and a maximum of three-node (<code>--nodes-max 3</code>) for this node group managed by EKS. The node group is named <code>sterling-workers</code>.</li><li>Create a node group with the name <code>sterling-workers</code> and select a machine type for the <code>sterling-workers</code> node group.</li></ul><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">eksctl create cluster \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">name sterling</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">east \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">version </span><span class="token number" style="color:#5a9bcf">1.24</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">region us</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">east</span><span class="token operator" style="color:#d7deea">-</span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token operator" style="color:#d7deea">--</span><span class="token keyword" style="color:#c5a5c5">with</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">oidc \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">zones us</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">east</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">1a</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain">us</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">east</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">1b</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain">us</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">east</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">1c \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">nodegroup</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">name sterling</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">workers \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">node</span><span class="token operator" style="color:#d7deea">-</span><span class="token keyword" style="color:#c5a5c5">type</span><span class="token plain"> </span><span class="token class-name" style="color:#FAC863">m5</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">xlarge</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">nodes </span><span class="token number" style="color:#5a9bcf">3</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">nodes</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">min </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">nodes</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">max </span><span class="token number" style="color:#5a9bcf">3</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">tags </span><span class="token string" style="color:#8dc891">&quot;Product=Sterling&quot;</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">managed</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Associate an IAM oidc provider with the cluster if you didn&#x27;t include <code>--with-oidc</code> above. Make sure to use the region you created the cluster in.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">eksctl utils associate-iam-oidc-provider --region=us-east-1 --cluster=sterling-east --approve</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Once the cluster is up, add it to your kube config. <code>eksctl</code> will probably do this for you.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">aws eks update-kubeconfig --name sterling-east --region us-east-1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="prepare-the-cluster">Prepare the cluster<a href="#prepare-the-cluster" class="hash-link" aria-label="Direct link to Prepare the cluster" title="Direct link to Prepare the cluster">​</a></h2><p>Create a namespace and set the context. This is where we will be living for the duration of the installation.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">kubectl create namespace sterling</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">kubectl config set-context --current --namespace=sterling</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="install-the-eks-helm-repo">Install the EKS helm repo<a href="#install-the-eks-helm-repo" class="hash-link" aria-label="Direct link to Install the EKS helm repo" title="Direct link to Install the EKS helm repo">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">helm repo </span><span class="token function" style="color:#79b6f2">add</span><span class="token plain"> eks https://aws.github.io/eks-charts</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">helm repo update</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="install-the-ebs-driver-to-the-cluster">Install the EBS driver to the cluster<a href="#install-the-ebs-driver-to-the-cluster" class="hash-link" aria-label="Direct link to Install the EBS driver to the cluster" title="Direct link to Install the EBS driver to the cluster">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="download-the-example-ebs-iam-policy">Download the example ebs iam policy<a href="#download-the-example-ebs-iam-policy" class="hash-link" aria-label="Direct link to Download the example ebs iam policy" title="Direct link to Download the example ebs iam policy">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">curl -o iam-policy-example-ebs.json https://raw.githubusercontent.com/kubernetes-sigs/aws-ebs-csi-driver/master/docs/example-iam-policy.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Create the policy. You can change  <code>AmazonEKS_EBS_CSI_Driver_Policy</code> to a different name, but if you do, make sure to change it in later steps too.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">aws iam create</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">policy \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">policy</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">name </span><span class="token maybe-class-name">AmazonEKS_EBS_CSI_Driver_Policy</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">policy</span><span class="token operator" style="color:#d7deea">-</span><span class="token dom variable" style="color:#d7deea">document</span><span class="token plain"> file</span><span class="token operator" style="color:#d7deea">:</span><span class="token operator" style="color:#d7deea">/</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">iam</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">policy</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">example</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">ebs</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">json</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token string-property property" style="color:#5a9bcf">&quot;Policy&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;PolicyName&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;AmazonEKS_EBS_CSI_Driver_Policy&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;PolicyId&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;ANPA24LVTCGN5YOUAVX2V&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;Arn&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;arn:aws:iam::&lt;ACCOUNTID&gt;:policy/AmazonEKS_EBS_CSI_Driver_Policy&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;Path&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;/&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;DefaultVersionId&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;v1&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;AttachmentCount&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">0</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;PermissionsBoundaryUsageCount&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">0</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;IsAttachable&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token boolean" style="color:#ff8b50">true</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;CreateDate&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;2023-04-19T14:17:03+00:00&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;UpdateDate&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;2023-04-19T14:17:03+00:00&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-the-service-account">Create the service account<a href="#create-the-service-account" class="hash-link" aria-label="Direct link to Create the service account" title="Direct link to Create the service account">​</a></h3><p>Create the service account using the <code>arn</code> returned above.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">eksctl create iamserviceaccount \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">name ebs</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">csi</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">controller</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">sa \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token operator" style="color:#d7deea">--</span><span class="token keyword" style="color:#c5a5c5">namespace</span><span class="token plain"> kube</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">system \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">cluster sterling</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">east \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">attach</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">policy</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">arn arn</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain">aws</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain">iam</span><span class="token operator" style="color:#d7deea">:</span><span class="token operator" style="color:#d7deea">:</span><span class="token tag punctuation" style="color:#8dc891">&lt;</span><span class="token tag class-name" style="color:#FAC863">ACCOUNTID</span><span class="token tag punctuation" style="color:#8dc891">&gt;</span><span class="token plain-text">:policy/AmazonEKS_EBS_CSI_Driver_Policy \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain-text">  --approve \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain-text">  --role-only \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain-text">  --role-name AmazonEKS_EBS_CSI_DriverRole</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Create the addon for the cluster using the <code>arn</code> returned from the command above.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">eksctl create addon \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">name aws</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">ebs</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">csi</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">driver \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">cluster sterling</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">east \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">service</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">account</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">role</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">arn arn</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain">aws</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain">iam</span><span class="token operator" style="color:#d7deea">:</span><span class="token operator" style="color:#d7deea">:</span><span class="token tag punctuation" style="color:#8dc891">&lt;</span><span class="token tag class-name" style="color:#FAC863">ACCOUNTID</span><span class="token tag punctuation" style="color:#8dc891">&gt;</span><span class="token plain-text">:role/AmazonEKS_EBS_CSI_DriverRole \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain-text">--force</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-the-storageclass">Create the StorageClass<a href="#create-the-storageclass" class="hash-link" aria-label="Direct link to Create the StorageClass" title="Direct link to Create the StorageClass">​</a></h3><p>Create the following StorageClass yaml to use gp3</p><p><code>gp3-sc.yaml</code></p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token key atrule" style="color:#FAC863">apiVersion</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> storage.k8s.io/v1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">kind</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> StorageClass</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">metadata</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> ebs</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">gp3</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">sc</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">provisioner</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> ebs.csi.aws.com</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">parameters</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">type</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> gp3</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">fsType</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> ext4</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">reclaimPolicy</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> Delete</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">volumeBindingMode</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> WaitForFirstConsumer</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Create the storage class</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">kubectl apply </span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">f gp3</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">sc</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="prepare-efs-storage-for-the-cluster">Prepare EFS storage for the cluster<a href="#prepare-efs-storage-for-the-cluster" class="hash-link" aria-label="Direct link to Prepare EFS storage for the cluster" title="Direct link to Prepare EFS storage for the cluster">​</a></h2><p>By default when we create a cluster with eksctl it defines and installs <code>gp2</code> storage class which is backed by Amazon&#x27;s EBS (elastic block storage). Being block storage, it&#x27;s not super happy supporting RWX in our cluster. We need to install an EFS storage class.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-an-iam-policy-and-role">Create an IAM policy and role<a href="#create-an-iam-policy-and-role" class="hash-link" aria-label="Direct link to Create an IAM policy and role" title="Direct link to Create an IAM policy and role">​</a></h3><p>Create an IAM policy and assign it to an IAM role. The policy will allow the Amazon EFS driver to interact with your file system.</p><p>Download the example policy.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">curl </span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">o iam</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">policy</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">example</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">efs</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">json</span><span class="token plain"> https</span><span class="token operator" style="color:#d7deea">:</span><span class="token operator" style="color:#d7deea">/</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">raw</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">githubusercontent</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">com</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">kubernetes</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">sigs</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">aws</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">efs</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">csi</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">driver</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">master</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">docs</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">iam</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">policy</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">example</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Create the policy</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">aws iam create</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">policy \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">policy</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">name </span><span class="token maybe-class-name">AmazonEKS_EFS_CSI_Driver_Policy</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">policy</span><span class="token operator" style="color:#d7deea">-</span><span class="token dom variable" style="color:#d7deea">document</span><span class="token plain"> file</span><span class="token operator" style="color:#d7deea">:</span><span class="token operator" style="color:#d7deea">/</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">iam</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">policy</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">example</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">efs</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">json</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token string-property property" style="color:#5a9bcf">&quot;Policy&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;PolicyName&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;AmazonEKS_EFS_CSI_Driver_Policy&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;PolicyId&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;ANPA24LVTCGN7YGDYRWJT&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;Arn&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;arn:aws:iam::&lt;ACCOUNTID&gt;:policy/AmazonEKS_EFS_CSI_Driver_Policy&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;Path&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;/&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;DefaultVersionId&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;v1&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;AttachmentCount&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">0</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;PermissionsBoundaryUsageCount&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">0</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;IsAttachable&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token boolean" style="color:#ff8b50">true</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;CreateDate&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;2023-01-24T17:24:00+00:00&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;UpdateDate&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;2023-01-24T17:24:00+00:00&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Create an IAM role and attach the IAM policy to it. Annotate the Kubernetes service account with the IAM role ARN and the IAM role with the Kubernetes service account name. You can create the role using <code>eksctl</code> or the AWS CLI. We&#x27;re going to use <code>eksctl</code>, Also our <code>Arn</code> is returned in the output above, so we&#x27;ll use it here.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">eksctl create iamserviceaccount \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">cluster sterling</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">east \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token keyword" style="color:#c5a5c5">namespace</span><span class="token plain"> kube</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">system \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">name efs</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">csi</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">controller</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">sa \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">attach</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">policy</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">arn arn</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain">aws</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain">iam</span><span class="token operator" style="color:#d7deea">:</span><span class="token operator" style="color:#d7deea">:</span><span class="token tag punctuation" style="color:#8dc891">&lt;</span><span class="token tag class-name" style="color:#FAC863">ACCOUNTID</span><span class="token tag punctuation" style="color:#8dc891">&gt;</span><span class="token plain-text">:policy/AmazonEKS_EFS_CSI_Driver_Policy \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain-text">    --approve \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain-text">    --region us-east-1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now we just need our add-on registry address. This can be found here: <a href="https://docs.aws.amazon.com/eks/latest/userguide/add-ons-images.html" target="_blank" rel="noopener noreferrer">https://docs.aws.amazon.com/eks/latest/userguide/add-ons-images.html</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="install-the-driver-add-on">Install the driver add-on<a href="#install-the-driver-add-on" class="hash-link" aria-label="Direct link to Install the driver add-on" title="Direct link to Install the driver add-on">​</a></h3><p>Let&#x27;s install the driver add-on to our clusters. We&#x27;re going to use <code>helm</code> for this.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">helm repo add aws</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">efs</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">csi</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">driver https</span><span class="token operator" style="color:#d7deea">:</span><span class="token operator" style="color:#d7deea">/</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">kubernetes</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">sigs</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">github</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">io</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">aws</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">efs</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">csi</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">driver</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">helm repo update</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Install a release of the driver using the Helm chart. Replace the repository address with the cluster&#x27;s <a href="https://docs.aws.amazon.com/eks/latest/userguide/add-ons-images.html" target="_blank" rel="noopener noreferrer">container image address</a>.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">helm upgrade </span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">i aws</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">efs</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">csi</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">driver aws</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">efs</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">csi</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">driver</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">aws</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">efs</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">csi</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">driver \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token keyword" style="color:#c5a5c5">namespace</span><span class="token plain"> kube</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">system \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token keyword" style="color:#c5a5c5">set</span><span class="token plain"> image</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">repository</span><span class="token operator" style="color:#d7deea">=</span><span class="token number" style="color:#5a9bcf">602401143452</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">dkr</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">ecr</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">us</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">east</span><span class="token operator" style="color:#d7deea">-</span><span class="token number" style="color:#5a9bcf">1</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">amazonaws</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">com</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">eks</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">aws</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">efs</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">csi</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">driver \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token keyword" style="color:#c5a5c5">set</span><span class="token plain"> controller</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">serviceAccount</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">create</span><span class="token operator" style="color:#d7deea">=</span><span class="token boolean" style="color:#ff8b50">false</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token keyword" style="color:#c5a5c5">set</span><span class="token plain"> controller</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">serviceAccount</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">name</span><span class="token operator" style="color:#d7deea">=</span><span class="token plain">efs</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">csi</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">controller</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">sa</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-the-filesystem">Create the filesystem<a href="#create-the-filesystem" class="hash-link" aria-label="Direct link to Create the filesystem" title="Direct link to Create the filesystem">​</a></h3><p>Now we need to create the filesystem in EFS so we can use it</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token keyword" style="color:#c5a5c5">export</span><span class="token plain"> clustername</span><span class="token operator" style="color:#d7deea">=</span><span class="token plain">sterling</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">east</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">export</span><span class="token plain"> region</span><span class="token operator" style="color:#d7deea">=</span><span class="token plain">us</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">east</span><span class="token operator" style="color:#d7deea">-</span><span class="token number" style="color:#5a9bcf">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Get our VPC ID</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">vpc_id</span><span class="token operator" style="color:#d7deea">=</span><span class="token function" style="color:#79b6f2">$</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">aws eks describe</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">cluster \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">name $clustername \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">query </span><span class="token string" style="color:#8dc891">&quot;cluster.resourcesVpcConfig.vpcId&quot;</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">region $region \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">output text</span><span class="token punctuation" style="color:#8dc891">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Retrieve the CIDR range for your cluster&#x27;s VPC and store it in a variable for use in a later step.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">cidr_range</span><span class="token operator" style="color:#d7deea">=</span><span class="token function" style="color:#79b6f2">$</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">aws ec2 describe</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">vpcs \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">vpc</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">ids $vpc_id \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">query </span><span class="token string" style="color:#8dc891">&quot;Vpcs[].CidrBlock&quot;</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">output text \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">region $region</span><span class="token punctuation" style="color:#8dc891">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Create a security group with an inbound rule that allows inbound NFS traffic for your Amazon EFS mount points.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">security_group_id</span><span class="token operator" style="color:#d7deea">=</span><span class="token function" style="color:#79b6f2">$</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">aws ec2 create</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">security</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">group \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">group</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">name </span><span class="token maybe-class-name">EFS4SterlingSecurityGroup</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">description </span><span class="token string" style="color:#8dc891">&quot;EFS security group for sterling Clusters&quot;</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">vpc</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">id $vpc_id \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">region $region \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">output text</span><span class="token punctuation" style="color:#8dc891">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Create an inbound rule that allows inbound NFS traffic from the CIDR for your cluster&#x27;s VPC.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">aws ec2 authorize</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">security</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">group</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">ingress \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">group</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">id $security_group_id \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">protocol tcp \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">port </span><span class="token number" style="color:#5a9bcf">2049</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">region $region \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">cidr $cidr_range</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Create a file system.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">file_system_id</span><span class="token operator" style="color:#d7deea">=</span><span class="token function" style="color:#79b6f2">$</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">aws efs create</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">file</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">system \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">region $region \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">encrypted \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token dom variable" style="color:#d7deea">performance</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">mode generalPurpose \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">query </span><span class="token string" style="color:#8dc891">&#x27;FileSystemId&#x27;</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">output text</span><span class="token punctuation" style="color:#8dc891">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-the-mount-targets">Create the mount targets<a href="#create-the-mount-targets" class="hash-link" aria-label="Direct link to Create the mount targets" title="Direct link to Create the mount targets">​</a></h3><p>Create mount targets.</p><p>Determine the IDs of the subnets in your VPC and which Availability Zone the subnet is in.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">aws ec2 describe</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">subnets \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">filters </span><span class="token string" style="color:#8dc891">&quot;Name=vpc-id,Values=$vpc_id&quot;</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">query </span><span class="token string" style="color:#8dc891">&#x27;Subnets[*].{SubnetId: SubnetId,AvailabilityZone: AvailabilityZone,CidrBlock: CidrBlock}&#x27;</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">region $region \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">output table</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Should output the following</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">----------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">|                           DescribeSubnets                          |</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">+------------------+--------------------+----------------------------+</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">| AvailabilityZone |     CidrBlock      |         SubnetId           |</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">+------------------+--------------------+----------------------------+</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">|  us-east-1a      |  192.168.0.0/19    |  subnet-08ddff738c8fac2db  |</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">|  us-east-1b      |  192.168.32.0/19   |  subnet-0e11acfc0a427d52d  |</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">|  us-east-1b      |  192.168.128.0/19  |  subnet-0dd9067f0f828e49c  |</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">|  us-east-1c      |  192.168.160.0/19  |  subnet-0da98130d8b80f210  |</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">|  us-east-1a      |  192.168.96.0/19   |  subnet-02b159221adb9b790  |</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">|  us-east-1c      |  192.168.64.0/19   |  subnet-01987475cac20b583  |</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">+------------------+--------------------+----------------------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Add mount targets for the subnets that your nodes are in.</p><p>Run the following command:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token keyword" style="color:#c5a5c5">for</span><span class="token plain"> </span><span class="token for-or-select variable" style="color:#d7deea">subnet</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">in</span><span class="token plain"> </span><span class="token variable" style="color:#d7deea">$(</span><span class="token variable" style="color:#d7deea">aws ec2 describe-subnets --filters </span><span class="token variable string" style="color:#8dc891">&quot;Name=vpc-id,Values=</span><span class="token variable string variable" style="color:#d7deea">$vpc_id</span><span class="token variable string" style="color:#8dc891">&quot;</span><span class="token variable" style="color:#d7deea"> --query </span><span class="token variable string" style="color:#8dc891">&#x27;Subnets[*].{SubnetId: SubnetId,AvailabilityZone: AvailabilityZone,CidrBlock: CidrBlock}&#x27;</span><span class="token variable" style="color:#d7deea"> --region $region --output text </span><span class="token variable operator" style="color:#d7deea">|</span><span class="token variable" style="color:#d7deea"> </span><span class="token variable function" style="color:#79b6f2">awk</span><span class="token variable" style="color:#d7deea"> </span><span class="token variable string" style="color:#8dc891">&#x27;{print $3}&#x27;</span><span class="token variable" style="color:#d7deea">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">do</span><span class="token plain"> aws efs create-mount-target --file-system-id </span><span class="token variable" style="color:#d7deea">$file_system_id</span><span class="token plain"> --region </span><span class="token variable" style="color:#d7deea">$region</span><span class="token plain"> --subnet-id </span><span class="token variable" style="color:#d7deea">$subnet</span><span class="token plain"> --security-groups </span><span class="token variable" style="color:#d7deea">$security_group_id</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">done</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This wraps the below command in a for loop that will iterate through your subnet ids.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">aws efs create</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">mount</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">target \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">file</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">system</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">id $file_system_id \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">region $region \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">subnet</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">id </span><span class="token tag punctuation" style="color:#8dc891">&lt;</span><span class="token tag class-name" style="color:#FAC863">SUBNETID</span><span class="token tag punctuation" style="color:#8dc891">&gt;</span><span class="token plain-text"> \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain-text">    --security-groups $security_group_id</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-the-storage-classes">Create the storage classes<a href="#create-the-storage-classes" class="hash-link" aria-label="Direct link to Create the storage classes" title="Direct link to Create the storage classes">​</a></h3><p>Create a storage class for dynamic provisioning</p><p>Let&#x27;s get our filesystem ID if we don&#x27;t already have it above. However if you ran the above steps, <code>$file_system_id</code> should already be defined.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">aws efs describe</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">file</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">systems \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">query </span><span class="token string" style="color:#8dc891">&quot;FileSystems[*].FileSystemId&quot;</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">region $region \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">output text</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">fs</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">071439ffb7e10b67b</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Download a <code>StorageClass</code> manifest for Amazon EFS.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">curl </span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">o </span><span class="token maybe-class-name">EFSStorageClass</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">yaml</span><span class="token plain"> https</span><span class="token operator" style="color:#d7deea">:</span><span class="token operator" style="color:#d7deea">/</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">raw</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">githubusercontent</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">com</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">kubernetes</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">sigs</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">aws</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">efs</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">csi</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">driver</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">master</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">examples</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">kubernetes</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">dynamic_provisioning</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">specs</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">storageclass</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Configure two separate EFS storage classes, one for Sterling and one for MQ. The reason for this is MQ requires specific userids to work happily when using shared storage whereas Sterling requires its own user to own stuff and might cause conflicts. By specifying separate classes we eliminate the problem. Make sure the <code>fileSystemId</code> is the same for both.</p><p>Update it with the storage class id</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token function" style="color:#79b6f2">sed</span><span class="token plain"> -i </span><span class="token string" style="color:#8dc891">&#x27;s/fileSystemId:.*/fileSystemId: fs-071439ffb7e10b67b/&#x27;</span><span class="token plain"> EFSStorageClass.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>EFSStorageClass.yaml</code></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">kind: StorageClass</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">apiVersion: storage.k8s.io/v1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  name: efs-mq-sc</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">provisioner: efs.csi.aws.com</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">mountOptions:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - tls</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">parameters:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  provisioningMode: efs-ap</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  fileSystemId: fs-071439ffb7e10b67b</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  directoryPerms: &quot;775&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  gidRangeStart: &quot;1000&quot; # optional</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  gidRangeEnd: &quot;3000&quot; # optional</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  basePath: &quot;/efs/dynamic_provisioning&quot; # optional</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  uid: &quot;2001&quot; # This tells the provisioner to make the owner this uid</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  gid: &quot;65534&quot; # This tells the provisioner to make the group owner this gid</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">---</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">kind: StorageClass</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">apiVersion: storage.k8s.io/v1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  name: efs-sfg-sc</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">provisioner: efs.csi.aws.com</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">mountOptions:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - tls</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">parameters:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  provisioningMode: efs-ap</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  fileSystemId: fs-071439ffb7e10b67b</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  directoryPerms: &quot;775&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  gidRangeStart: &quot;1000&quot; # optional</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  gidRangeEnd: &quot;3000&quot; # optional</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  basePath: &quot;/efs/dynamic_provisioning&quot; # optional</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  uid: &quot;1010&quot; # This tells the provisioner to make the owner this uid</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  gid: &quot;1010&quot; # This tells the provisioner to make the group owner this gid</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Deploy the storage class.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">kubectl apply -f EFSStorageClass.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Finally, verify it&#x27;s there</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">kubectl </span><span class="token keyword" style="color:#c5a5c5">get</span><span class="token plain"> sc</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token constant" style="color:#5a9bcf">NAME</span><span class="token plain">            </span><span class="token constant" style="color:#5a9bcf">PROVISIONER</span><span class="token plain">             </span><span class="token constant" style="color:#5a9bcf">RECLAIMPOLICY</span><span class="token plain">   </span><span class="token constant" style="color:#5a9bcf">VOLUMEBINDINGMODE</span><span class="token plain">      </span><span class="token constant" style="color:#5a9bcf">ALLOWVOLUMEEXPANSION</span><span class="token plain">   </span><span class="token constant" style="color:#5a9bcf">AGE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">efs</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">mq</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">sc          efs</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">csi</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">aws</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">com</span><span class="token plain">         </span><span class="token maybe-class-name">Delete</span><span class="token plain">          </span><span class="token maybe-class-name">Immediate</span><span class="token plain">              </span><span class="token boolean" style="color:#ff8b50">false</span><span class="token plain">                  7s</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">efs</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">sfg</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">sc          efs</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">csi</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">aws</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">com</span><span class="token plain">         </span><span class="token maybe-class-name">Delete</span><span class="token plain">          </span><span class="token maybe-class-name">Immediate</span><span class="token plain">              </span><span class="token boolean" style="color:#ff8b50">false</span><span class="token plain">                  7s</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token function" style="color:#79b6f2">gp2</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">(</span><span class="token keyword" style="color:#c5a5c5">default</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain">   kubernetes</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">io</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">aws</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">ebs   </span><span class="token maybe-class-name">Delete</span><span class="token plain">          </span><span class="token maybe-class-name">WaitForFirstConsumer</span><span class="token plain">   </span><span class="token boolean" style="color:#ff8b50">false</span><span class="token plain">                  13d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="install-the-loadbalancer-controller">Install the Loadbalancer controller<a href="#install-the-loadbalancer-controller" class="hash-link" aria-label="Direct link to Install the Loadbalancer controller" title="Direct link to Install the Loadbalancer controller">​</a></h2><p>Let&#x27;s install the loadbalancer controller to the cluster</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-the-iam-policy">Create the IAM Policy<a href="#create-the-iam-policy" class="hash-link" aria-label="Direct link to Create the IAM Policy" title="Direct link to Create the IAM Policy">​</a></h3><p>Download an IAM policy for the AWS Load Balancer Controller that allows it to make calls to AWS APIs on your behalf.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token function" style="color:#79b6f2">curl</span><span class="token plain"> -O https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.4.4/docs/install/iam_policy.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Create an IAM policy using the policy downloaded in the previous step.</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">aws iam create</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">policy \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">policy</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">name </span><span class="token maybe-class-name">AWSLoadBalancerControllerIAMPolicy</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token operator" style="color:#d7deea">--</span><span class="token plain">policy</span><span class="token operator" style="color:#d7deea">-</span><span class="token dom variable" style="color:#d7deea">document</span><span class="token plain"> file</span><span class="token operator" style="color:#d7deea">:</span><span class="token operator" style="color:#d7deea">/</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">iam_policy</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">json</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token string-property property" style="color:#5a9bcf">&quot;Policy&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;PolicyName&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;AWSLoadBalancerControllerIAMPolicy&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;PolicyId&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;ANPA24LVTCGNV55JFAAP5&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;Arn&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;arn:aws:iam::&lt;ACCOUNTID&gt;:policy/AWSLoadBalancerControllerIAMPolicy&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;Path&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;/&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;DefaultVersionId&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;v1&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;AttachmentCount&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">0</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;PermissionsBoundaryUsageCount&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">0</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;IsAttachable&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token boolean" style="color:#ff8b50">true</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;CreateDate&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;2023-01-17T20:22:23+00:00&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string-property property" style="color:#5a9bcf">&quot;UpdateDate&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;2023-01-17T20:22:23+00:00&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Create an IAM role. Create a Kubernetes service account named <code>aws-load-balancer-controller</code> in the <code>kube-system</code> namespace for the AWS Load Balancer Controller and annotate the Kubernetes service account with the name of the IAM role.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">eksctl create iamserviceaccount </span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  --cluster</span><span class="token operator" style="color:#d7deea">=</span><span class="token plain">sterling-east </span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  --namespace</span><span class="token operator" style="color:#d7deea">=</span><span class="token plain">kube-system </span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  --name</span><span class="token operator" style="color:#d7deea">=</span><span class="token plain">aws-load-balancer-controller-sterling </span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  --role-name AmazonEKSsterlingLoadBalancerControllerRolesterling </span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  --attach-policy-arn</span><span class="token operator" style="color:#d7deea">=</span><span class="token plain">arn:aws:iam::</span><span class="token operator" style="color:#d7deea">&lt;</span><span class="token plain">ACCOUNTID</span><span class="token operator" style="color:#d7deea">&gt;</span><span class="token plain">:policy/AWSLoadBalancerControllerIAMPolicy </span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  --approve</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="install-the-aws-load-balancer-controller">Install the AWS Load Balancer Controller.<a href="#install-the-aws-load-balancer-controller" class="hash-link" aria-label="Direct link to Install the AWS Load Balancer Controller." title="Direct link to Install the AWS Load Balancer Controller.">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">helm </span><span class="token function" style="color:#79b6f2">install</span><span class="token plain"> aws-load-balancer-controller eks/aws-load-balancer-controller </span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  -n kube-system </span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  --set </span><span class="token assign-left variable" style="color:#d7deea">clusterName</span><span class="token operator" style="color:#d7deea">=</span><span class="token plain">sterling-east </span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  --set serviceAccount.create</span><span class="token operator" style="color:#d7deea">=</span><span class="token plain">false </span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  --set serviceAccount.name</span><span class="token operator" style="color:#d7deea">=</span><span class="token plain">aws-load-balancer-controller-sterling</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">NAME: aws-load-balancer-controller</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">LAST DEPLOYED: Tue Jan </span><span class="token number" style="color:#5a9bcf">17</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">15</span><span class="token plain">:33:50 </span><span class="token number" style="color:#5a9bcf">2023</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">NAMESPACE: kube-system</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">STATUS: deployed</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">REVISION: </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">TEST SUITE: None</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">NOTES:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">AWS Load Balancer controller installed</span><span class="token operator" style="color:#d7deea">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="install-the-nginx-controller">Install the NGINX Controller<a href="#install-the-nginx-controller" class="hash-link" aria-label="Direct link to Install the NGINX Controller" title="Direct link to Install the NGINX Controller">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="get-the-nginx-controller-deployment">Get the NGINX controller deployment<a href="#get-the-nginx-controller-deployment" class="hash-link" aria-label="Direct link to Get the NGINX controller deployment" title="Direct link to Get the NGINX controller deployment">​</a></h3><p>Pull down the NGINX controller deployment</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token function" style="color:#79b6f2">wget</span><span class="token plain"> -O nginx-deploy.yaml https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/aws/deploy.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Modify the deployment file and add the following annotations</p><div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">service</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">beta</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">kubernetes</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">io</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">aws</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">load</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">balancer</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">type</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;external&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">service</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">beta</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">kubernetes</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">io</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">aws</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">load</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">balancer</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">nlb</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">target</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">type</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;instance&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">service</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">beta</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">kubernetes</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token property-access">io</span><span class="token operator" style="color:#d7deea">/</span><span class="token plain">aws</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">load</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">balancer</span><span class="token operator" style="color:#d7deea">-</span><span class="token plain">scheme</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;internet-facing&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="apply-the-deployment">Apply the deployment<a href="#apply-the-deployment" class="hash-link" aria-label="Direct link to Apply the deployment" title="Direct link to Apply the deployment">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">kubectl apply -f nginx-deploy.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="verify-the-deployment">Verify the deployment<a href="#verify-the-deployment" class="hash-link" aria-label="Direct link to Verify the deployment" title="Direct link to Verify the deployment">​</a></h3><p>Command:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">kubectl get ingressclass</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">NAME    CONTROLLER             PARAMETERS   AGE</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">alb     ingress.k8s.aws/alb    </span><span class="token operator" style="color:#d7deea">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#d7deea">&gt;</span><span class="token plain">       6d10h</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">nginx   k8s.io/ingress-nginx   </span><span class="token operator" style="color:#d7deea">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#d7deea">&gt;</span><span class="token plain">       7d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="security-rbacs">Security RBACS<a href="#security-rbacs" class="hash-link" aria-label="Direct link to Security RBACS" title="Direct link to Security RBACS">​</a></h2><p>The following sample file illustrates RBAC for the default service account with the target namespace as <code>sterling</code></p><p>Create a file called <code>sterling-rbac.yaml</code></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">kind: Role</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">apiVersion: rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  name: ibm-b2bi-role-sterling</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  namespace: sterling</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">rules:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - apiGroups: [&#x27;&#x27;,&#x27;batch&#x27;]</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    resources: [&#x27;secrets&#x27;,&#x27;configmaps&#x27;,&#x27;persistentvolumeclaims&#x27;,&#x27;pods&#x27;,&#x27;services&#x27;,&#x27;cronjobs&#x27;,&#x27;jobs&#x27;]</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    verbs: [&#x27;create&#x27;, &#x27;get&#x27;, &#x27;list&#x27;, &#x27;delete&#x27;, &#x27;patch&#x27;, &#x27;update&#x27;]</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">---</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">kind: RoleBinding</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">apiVersion: rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  name: ibm-b2bi-rolebinding-sterling</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  namespace: sterling</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">subjects:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - kind: ServiceAccount</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    name: default</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    namespace: sterling</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">roleRef:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  kind: Role</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  name: ibm-b2bi-role-sterling</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  apiGroup: rbac.authorization.k8s.io</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Apply it to the cluster</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">kubectl apply -f sterling-rbac.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="security-policies">Security Policies<a href="#security-policies" class="hash-link" aria-label="Direct link to Security Policies" title="Direct link to Security Policies">​</a></h2><p>With Kubernetes v1.25, Pod Security Policy (PSP) API has been removed and replaced with Pod Security Admission (PSA) contoller. Kubernetes PSA conroller enforces predefined Pod Security levels at the namespace level. The Kubernetes Pod Security Standards defines three different levels: privileged, baseline, and restricted. Refer to Kubernetes <!-- -->[<code>Pod Security Standards</code>]<!-- --> (<a href="https://kubernetes.io/docs/concepts/security/pod-security-standards/" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/concepts/security/pod-security-standards/</a>) documentation for more details. This chart is compatible with the restricted security level.</p><p>The version of kubernetes in EKS in our instance is 1.24. So the following policies would be applied. Below is an optional custom PSP definition based on the IBM restricted PSP.</p><p>Predefined PodSecurityPolicy name: <a href="https://ibm.biz/cpkspec-psp" target="_blank" rel="noopener noreferrer"><code>ibm-restricted-psp</code></a></p><p>From the user interface or command line, you can copy and paste the following snippets to create and enable the below custom PodSecurityPolicy based on IBM restricted PSP.</p><p><code>custom-podsecpolicy.yaml</code></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">apiVersion: policy/v1beta1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">kind: PodSecurityPolicy</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  name: &quot;ibm-b2bi-psp&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    app: &quot;ibm-b2bi-psp&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  privileged: false</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  allowPrivilegeEscalation: false</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  hostPID: false</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  hostIPC: false</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  hostNetwork: false</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  allowedCapabilities:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  requiredDropCapabilities:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - MKNOD</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - AUDIT_WRITE</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - KILL</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - NET_BIND_SERVICE</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - NET_RAW</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - FOWNER</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - FSETID</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - SYS_CHROOT</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - SETFCAP</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - SETPCAP</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - CHOWN</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - SETGID</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - SETUID</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - DAC_OVERRIDE</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  allowedHostPaths:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  runAsUser:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    rule: MustRunAsNonRoot</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  runAsGroup:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    rule: MustRunAs</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    ranges:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    - min: 1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      max: 4294967294</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  seLinux:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    rule: RunAsAny</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  supplementalGroups:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    rule: MustRunAs</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    ranges:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    - min: 1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      max: 4294967294</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  fsGroup:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    rule: MustRunAs</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    ranges:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    - min: 1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      max: 4294967294</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  volumes:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - configMap</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - emptyDir</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - projected</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - secret</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - downwardAPI</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - persistentVolumeClaim</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - nfs</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  forbiddenSysctls:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - &#x27;*&#x27;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">---</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">apiVersion: rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">kind: Role</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  name: &quot;ibm-b2bi-psp&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    app: &quot;ibm-b2bi-psp&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">rules:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">- apiGroups:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - policy</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  resourceNames:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - &quot;ibm-b2bi-psp&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  resources:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - podsecuritypolicies</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  verbs:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  - use</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">---</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">apiVersion: rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">kind: RoleBinding</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  name: &quot;ibm-b2bi-psp&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    app: &quot;ibm-b2bi-psp&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">roleRef:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  apiGroup: rbac.authorization.k8s.io</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  kind: Role</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  name: &quot;ibm-b2bi-psp&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">subjects:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">- apiGroup: rbac.authorization.k8s.io</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  kind: Group</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  name: system:serviceaccounts</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  namespace: sterling</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Apply it to the cluster</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">kubectl apply -f custom-podsecpolicy.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="aws-rdsdb">AWS RDS/DB<a href="#aws-rdsdb" class="hash-link" aria-label="Direct link to AWS RDS/DB" title="Direct link to AWS RDS/DB">​</a></h2><p>For this installation we will be using an Oracle Database hosted in AWS RDS.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-the-security-group">Create the security group<a href="#create-the-security-group" class="hash-link" aria-label="Direct link to Create the security group" title="Direct link to Create the security group">​</a></h3><p>Create a security group. We&#x27;re going to get our vpc for our sterling cluster first and use that here since we don&#x27;t have any default vpc.</p><p>Let&#x27;s export the following env vars</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">export clustername=sterling-east</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">export region=us-east-1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now let&#x27;s retrieve our vpc id</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">vpc_id=$(aws eks describe-cluster \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --name $clustername \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --query &quot;cluster.resourcesVpcConfig.vpcId&quot; \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --region $region \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --output text)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And with those vars set, let&#x27;s now create our security group</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">security_group_id=$(aws ec2 create-security-group \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --group-name RDSSterlingSecGroup \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --description &quot;RDS Access to Sterling Cluster&quot; \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --vpc-id $vpc_id \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --region $region \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --output text)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="retrieve-the-cidr-range-for-the-cluster-vpc">Retrieve the CIDR range for the cluster VPC<a href="#retrieve-the-cidr-range-for-the-cluster-vpc" class="hash-link" aria-label="Direct link to Retrieve the CIDR range for the cluster VPC" title="Direct link to Retrieve the CIDR range for the cluster VPC">​</a></h3><p>Retrieve the CIDR range for your cluster&#x27;s VPC and store it in a variable for use in a later step.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">cidr_range=$(aws ec2 describe-vpcs \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --vpc-ids $vpc_id \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --query &quot;Vpcs[].CidrBlock&quot; \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --output text \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --region $region)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="authorized-access-to-that-group">Authorized access to that group<a href="#authorized-access-to-that-group" class="hash-link" aria-label="Direct link to Authorized access to that group" title="Direct link to Authorized access to that group">​</a></h3><p>Let&#x27;s authorize access to that group for Oracle which uses port 1521</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">aws ec2 authorize-security-group-ingress \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --group-id $security_group_id \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --protocol tcp \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --port 1521 \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --region $region \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --cidr $cidr_range</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-the-db-subnet-group">Create the DB Subnet Group<a href="#create-the-db-subnet-group" class="hash-link" aria-label="Direct link to Create the DB Subnet Group" title="Direct link to Create the DB Subnet Group">​</a></h3><p>Let&#x27;s create a db subnet group. First get our existing subnet ids from our vpc</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">aws ec2 describe-subnets \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --filters &quot;Name=vpc-id,Values=$vpc_id&quot; \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --query &#x27;Subnets[*].{SubnetId: SubnetId,AvailabilityZone: AvailabilityZone,CidrBlock: CidrBlock}&#x27; \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --region $region \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --output table</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">----------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">|                           DescribeSubnets                          |</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">+------------------+--------------------+----------------------------+</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">| AvailabilityZone |     CidrBlock      |         SubnetId           |</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">+------------------+--------------------+----------------------------+</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">|  us-east-1a      |  192.168.0.0/19    |  subnet-08ddff738c8fac2db  |</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">|  us-east-1b      |  192.168.32.0/19   |  subnet-0e11acfc0a427d52d  |</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">|  us-east-1b      |  192.168.128.0/19  |  subnet-0dd9067f0f828e49c  |</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">|  us-east-1c      |  192.168.160.0/19  |  subnet-0da98130d8b80f210  |</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">|  us-east-1a      |  192.168.96.0/19   |  subnet-02b159221adb9b790  |</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">|  us-east-1c      |  192.168.64.0/19   |  subnet-01987475cac20b583  |</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">+------------------+--------------------+----------------------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now let&#x27;s create our db subnet group</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">aws rds create-db-subnet-group \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">--db-subnet-group-name &quot;sterling-rds-subnet-group&quot; \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">--db-subnet-group-description &quot;This is our cluster subnet ids authorized and grouped for RDS&quot; \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">--subnet-ids &quot;subnet-08ddff738c8fac2db&quot; &quot;subnet-0e11acfc0a427d52d&quot; &quot;subnet-0dd9067f0f828e49c&quot; &quot;subnet-0da98130d8b80f210&quot; &quot;subnet-02b159221adb9b790&quot; &quot;subnet-01987475cac20b583&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-the-rds-db-instance">Create the RDS DB instance<a href="#create-the-rds-db-instance" class="hash-link" aria-label="Direct link to Create the RDS DB instance" title="Direct link to Create the RDS DB instance">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">aws rds create-db-instance \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --engine oracle-ee \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --db-instance-identifier sterling-mft-db \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --allocated-storage 300 \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --multi-az \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --db-subnet-group-name sterling-rds-subnet-group \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --db-instance-class db.t3.large \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --vpc-security-group-ids $security_group_id \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --master-username oracleuser \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --master-user-password oraclepass \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    --backup-retention-period 3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>A default DB called <code>ORCL</code> will be created with a default admin user <code>oracleuser</code> with the password <code>oraclepass</code>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="configure-the-oracle-instance">Configure the Oracle Instance<a href="#configure-the-oracle-instance" class="hash-link" aria-label="Direct link to Configure the Oracle Instance" title="Direct link to Configure the Oracle Instance">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-a-client-pod">Create a client pod<a href="#create-a-client-pod" class="hash-link" aria-label="Direct link to Create a client pod" title="Direct link to Create a client pod">​</a></h3><p>Configure a pod in the <code>sterling</code> in your namespace using the below yaml:</p><p><code>oracle_client.yaml</code></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  name: oracleclient</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    app: oracleclient</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    - name: instantclient</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      image: ghcr.io/oracle/oraclelinux8-instantclient:19</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      command: [&quot;sleep&quot;]</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      args: [&quot;infinity&quot;]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Create the pod</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">kubectl apply -f oracle_client.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Verify the pod is up and running</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">kubectl get pods</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">NAME           READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">oracleclient   1/1     Running   0          22m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="connect-to-the-client-pod">Connect to the client pod<a href="#connect-to-the-client-pod" class="hash-link" aria-label="Direct link to Connect to the client pod" title="Direct link to Connect to the client pod">​</a></h3><p>Connect to your db instance. The user is <code>oracleuser</code> and the password is <code>oraclepass</code> as we set when we created the RDS instance. The port will be <code>1521</code>. We will retrieve the endpoint with the <code>aws</code> cli and export it as a var called <code>$endpoint</code>.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">endpoint=$(aws rds describe-db-instances --query &quot;DBInstances[*].Endpoint.Address&quot; --output text)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">kubectl exec -it oracleclient -- sqlplus &quot;oracleuser/oraclepass@(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=$endpoint)(PORT=1521))(CONNECT_DATA=(SID=ORCL)))&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">SQL*Plus: Release 19.0.0.0.0 - Production on Wed Feb 15 17:16:05 2023</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Version 19.18.0.0.0</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Copyright (c) 1982, 2022, Oracle.  All rights reserved.</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Last Successful login time: Wed Feb 15 2023 17:07:24 +00:00</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Connected to:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Oracle Database 19c Enterprise Edition Release 19.0.0.0.0 - Production</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Version 19.17.0.0.0</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">SQL&gt;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="configure-database">Configure database<a href="#configure-database" class="hash-link" aria-label="Direct link to Configure database" title="Direct link to Configure database">​</a></h3><p>Now that we have an Oracle RDS instance and we are logged in, we are going to configure the database in preparation for Sterling B2Bi installation.</p><p>Run the following SQL script that will do the following:</p><ol><li>Create a tablespace for user tables and indexes</li><li>Set newly created tablespace as default</li><li>Create a new user for Sterling. This is the user we will be using for the database.</li><li>Grant permissions to the Sterling user</li></ol><p>Copy and paste the following into the SQL cmdline prompt.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Create tablespace</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">CREATE TABLESPACE SI_USERS DATAFILE SIZE 1G AUTOEXTEND ON MAXSIZE 100G;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Set new tablespace as default</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">EXEC rdsadmin.rdsadmin_util.alter_default_tablespace(tablespace_name =&gt; &#x27;SI_USERS&#x27;);</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Create new user for Sterling</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">CREATE USER SI_USER IDENTIFIED BY dbpassword;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">Grant necessary permissions to newly created Sterling user</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">GRANT &quot;CONNECT&quot; TO SI_USER;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">ALTER USER SI_USER DEFAULT ROLE &quot;CONNECT&quot;;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">ALTER USER SI_USER QUOTA 100G ON SI_USERS;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">GRANT CREATE SEQUENCE TO SI_USER;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">GRANT CREATE TABLE TO SI_USER;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">GRANT CREATE TRIGGER TO SI_USER;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">GRANT SELECT ON CTXSYS.CTX_USER_INDEXES TO SI_USER;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">GRANT SELECT ON SYS.DBA_DATA_FILES TO SI_USER;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">GRANT SELECT ON SYS.DBA_FREE_SPACE TO SI_USER;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">GRANT SELECT ON SYS.DBA_USERS TO SI_USER;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">GRANT SELECT ON SYS.V_$PARAMETER TO SI_USER;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">GRANT SELECT ANY DICTIONARY TO SI_USER;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">GRANT ALTER SESSION TO SI_USER;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">GRANT CREATE SESSION TO SI_USER;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">GRANT CREATE VIEW TO SI_USER;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-ibm-mq-to-the-cluster">Deploy IBM MQ to the cluster<a href="#deploy-ibm-mq-to-the-cluster" class="hash-link" aria-label="Direct link to Deploy IBM MQ to the cluster" title="Direct link to Deploy IBM MQ to the cluster">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-mq-namespace-optional">Create MQ Namespace (optional)<a href="#create-mq-namespace-optional" class="hash-link" aria-label="Direct link to Create MQ Namespace (optional)" title="Direct link to Create MQ Namespace (optional)">​</a></h3><p>Create a new namespace for MQ. This is optional if you&#x27;d rather just run MQ in the same namespace as Sterling b2bi then skip this step.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">kubectl create namespace mqsterling</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Set our context to it</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">kubectl config set-context --current --namespace=mqsterling</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-an-mq-overrides-file">Create an MQ overrides file<a href="#create-an-mq-overrides-file" class="hash-link" aria-label="Direct link to Create an MQ overrides file" title="Direct link to Create an MQ overrides file">​</a></h3><p>Create a values file called <code>sterling_values.yaml</code></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain"># © Copyright IBM Corporation 2021, 2022</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">#</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"># you may not use this file except in compliance with the License.</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"># You may obtain a copy of the License at</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">#</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"># http://www.apache.org/licenses/LICENSE-2.0</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">#</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"># Unless required by applicable law or agreed to in writing, software</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"># See the License for the specific language governing permissions and</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"># limitations under the License.</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">license: accept</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">log:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  debug: false</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">image:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  # repository is the container repository to use</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  # repository: &lt;URL FOR AIRGAPPED REPO&gt;/icr.io/ibm-messaging/mq</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  # This should point to either the IBM repo by default or it can be changed to point elsewhere.</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  repository: icr.io/ibm-messaging/mq</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  # tag is the tag to use for the container repository</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  tag: latest</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  # pullSecret is the secret to use when pulling the image from a private registry</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  # pullSecret: ics-cots-pullsecret</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  pullSecret:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  # pullPolicy is either IfNotPresent or Always (https://kubernetes.io/docs/concepts/containers/images/)</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  pullPolicy: IfNotPresent</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">queueManager:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  name: b2bi</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  nativeha:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    enable: true</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  multiinstance:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    enable: false</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">metrics:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  enabled: true</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">persistence:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  dataPVC:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    enable: true</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    name: &quot;data&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    size: 2Gi</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    storageClassName: &quot;efs-mq-sc&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  logPVC:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    enable: true</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    name: &quot;log&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    size: 2Gi</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    storageClassName: &quot;efs-mq-sc&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  qmPVC:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    enable: true</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    name: &quot;qm&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    size: 2Gi</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    storageClassName: &quot;efs-mq-sc&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">security:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  context:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    fsGroup: 65534</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">#    fsGroup: 0</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    supplementalGroups: [65534,2001]</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  initVolumeAsRoot: false</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  runAsUser: 2001</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  runAsGroup: 2001</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    productName: &quot;IBM MQ Advanced for Developers&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    productID: &quot;2f886a3eefbe4ccb89b2adb97c78b9cb&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    productChargedContainers: &quot;&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    productMetric: &quot;FREE&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">route:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  nodePort:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    webconsole: false</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    mqtraffic: true</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  loadBalancer:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    webconsole: false</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    mqtraffic: true</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  ingress:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    webconsole:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      enable: false</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      hostname:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      path: /ibmmq</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      tls:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        enable: false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="install-ibm-mq">Install IBM MQ<a href="#install-ibm-mq" class="hash-link" aria-label="Direct link to Install IBM MQ" title="Direct link to Install IBM MQ">​</a></h3><p>Install IBM MQ with the following command</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">helm install sterlingmq ibm-messaging-mq/ibm-mq \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">-f sterling_values.yaml \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">--set &quot;queueManager.envVariables[0].name=MQ_ADMIN_PASSWORD&quot; \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">--set &quot;queueManager.envVariables[0].value=mqpasswd&quot; \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">--set &quot;queueManager.envVariables[1].name=MQ_APP_PASSWORD&quot; \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">--set &quot;queueManager.envVariables[1].value=mqpasswd&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The command above will create a loadbalancer with port 1414 as the access port for the queue manager.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-the-mq-secret">Create the MQ Secret.<a href="#create-the-mq-secret" class="hash-link" aria-label="Direct link to Create the MQ Secret." title="Direct link to Create the MQ Secret.">​</a></h3><p>This needs to be created in the sterling namespace where B2Bi will be installed.</p><p><code>mqsecret.yaml</code></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">kind: Secret</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    name: mq-secret</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">type: Opaque</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">stringData:</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    JMS_USERNAME: mqadmin</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    JMS_PASSWORD: mqpasswd</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"># Set these values if we have setup our keystores for MQ</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">#  JMS_KEYSTORE_PASSWORD: </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">#  JMS_TRUSTSTORE_PASSWORD: </span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">#    </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>apply the secret to the sterling namespace</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">kubectl apply -f mqsecret.yaml -n sterling</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="retrieve-mqs-cluster-ip">Retrieve MQ&#x27;s cluster-ip<a href="#retrieve-mqs-cluster-ip" class="hash-link" aria-label="Direct link to Retrieve MQ&#x27;s cluster-ip" title="Direct link to Retrieve MQ&#x27;s cluster-ip">​</a></h3><p>Retrieve the cluster-ip of MQ&#x27;s loadbalancer and make a note of it:</p><p>If you created a separate namespace for MQ</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">kubectl get services -n mqsterling</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If MQ is in the same namespace (sterling)</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">kubectl get services -n sterling</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Output:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">NAME                             TYPE           CLUSTER-IP       EXTERNAL-IP                                                                     PORT(S)             AGE</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">sterlingmq-ibm-mq                ClusterIP      10.100.251.229   &lt;none&gt;                                                                          9443/TCP,1414/TCP   70d</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">sterlingmq-ibm-mq-loadbalancer   LoadBalancer   10.100.98.89     k8s-mqsterli-sterling-6c00100a47-92a6027e40f34c81.elb.us-east-1.amazonaws.com   1414:30516/TCP      70d</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">sterlingmq-ibm-mq-metrics        ClusterIP      10.100.21.87     &lt;none&gt;                                                                          9157/TCP            70d</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">sterlingmq-ibm-mq-qm             NodePort       10.100.146.149   &lt;none&gt;                                                                          1414:30038/TCP      70d</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">sterlingmq-ibm-mq-web            NodePort       10.100.183.242   &lt;none&gt;                                                                          9443:32013/TCP      70d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the above return output, our cluster-ip for the loadbalancer for MQ is <code>10.100.98.89</code>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="role-based-s3-access">Role Based S3 access<a href="#role-based-s3-access" class="hash-link" aria-label="Direct link to Role Based S3 access" title="Direct link to Role Based S3 access">​</a></h2><p>You will need the following items if you are setting this up on a pre-existing S3 bucket:</p><ol><li>Bucket name</li><li>OIDC Provider: </li></ol><p>If you have an OIDC provider already associated with your eks cluster, you can retrieve that info with this command:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">aws eks describe-cluster \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">--name &lt;CLUSTERNAME&gt; \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">--query &quot;cluster.identity.oidc.issuer&quot; \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">--output text | sed &quot;s/https:\/\///&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">oidc.eks.us-east-1.amazonaws.com/id/9FD6ABAF8C2FCBAC9E899C79ACE7DF62</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="3"><li>KMS Key arn (if using KMS)</li><li>Account ID</li></ol><p>The rest of these instructions assume the creation of all these elements.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="bucket-creation">Bucket Creation<a href="#bucket-creation" class="hash-link" aria-label="Direct link to Bucket Creation" title="Direct link to Bucket Creation">​</a></h3><p>Let us create an S3 bucket to use for file transfers. </p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">aws s3api create-bucket \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">--bucket b2bis3bucket \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">--region us-east-1 \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">--object-ownership BucketOwnerEnforced</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This creates a standard bucket in the us-east-1 region that is bucket owner enforced and default encrypted with Server-side encryption with Amazon S3 managed keys (SSE-S3).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="using-kms-encryption-keys-on-s3-bucket-optional">Using KMS Encryption keys on S3 bucket (optional)<a href="#using-kms-encryption-keys-on-s3-bucket-optional" class="hash-link" aria-label="Direct link to Using KMS Encryption keys on S3 bucket (optional)" title="Direct link to Using KMS Encryption keys on S3 bucket (optional)">​</a></h3><p>By default AWS S3 buckets are encrypted with AWS SSE (server side encrypted) managed keys. But creating customer managed keys are also an option. </p><p>Create a KMS key</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">aws kms create-key</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">{</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    &quot;KeyMetadata&quot;: {</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;AWSAccountId&quot;: &lt;ACCOUNTID&gt;,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;KeyId&quot;: &quot;413d348e-1307-42a7-bb92-206017e8d81c&quot;,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;Arn&quot;: &quot;arn:aws:kms:us-east-1:&lt;ACCOUNTID&gt;:key/413d348e-1307-42a7-bb92-206017e8d81c&quot;,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;CreationDate&quot;: &quot;2023-06-20T15:58:39.275000-04:00&quot;,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;Enabled&quot;: true,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;Description&quot;: &quot;&quot;,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;KeyUsage&quot;: &quot;ENCRYPT_DECRYPT&quot;,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;KeyState&quot;: &quot;Enabled&quot;,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;Origin&quot;: &quot;AWS_KMS&quot;,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;KeyManager&quot;: &quot;CUSTOMER&quot;,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;CustomerMasterKeySpec&quot;: &quot;SYMMETRIC_DEFAULT&quot;,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;KeySpec&quot;: &quot;SYMMETRIC_DEFAULT&quot;,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;EncryptionAlgorithms&quot;: [</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            &quot;SYMMETRIC_DEFAULT&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        ],</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;MultiRegion&quot;: false</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Make a note of the returned key ARN <code>&quot;Arn&quot;: &quot;arn:aws:kms:us-east-1:&lt;ACCOUNTID&gt;:key/413d348e-1307-42a7-bb92-206017e8d81c&quot;,</code> as we will need it below if we are going to use KMS encryption.</p><p>Using the &quot;KeyId&quot; returned above, let&#x27;s create a key alias:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">aws kms create-alias \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">--alias-name alias/example-kms-key \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">--target-key-id &quot;413d348e-1307-42a7-bb92-206017e8d81c&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now let&#x27;s grab the alias ARN for the key we created:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">aws kms list-aliases --query &quot;Aliases[].AliasArn&quot; | grep example-kms-key</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">&quot;arn:aws:kms:us-east-1:&lt;ACCOUNTID&gt;:alias/example-kms-key&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And now set the default symmetric encryption to our bucket using our new KMS key</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">aws s3api put-bucket-encryption \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">--bucket b2bis3bucket \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">--server-side-encryption-configuration &#x27;{ &quot;Rules&quot;: [ { &quot;ApplyServerSideEncryptionByDefault&quot;: { &quot;SSEAlgorithm&quot;: &quot;aws:kms&quot;, &quot;KMSMasterKeyID&quot;: &quot;arn:aws:kms:us-east-1:&lt;ACCOUNTID&gt;:alias/example-kms-key&quot;}, &quot;BucketKeyEnabled&quot;: true } ] }&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-an-oidc-provider">Create an OIDC provider<a href="#create-an-oidc-provider" class="hash-link" aria-label="Direct link to Create an OIDC provider" title="Direct link to Create an OIDC provider">​</a></h3><p>For the EKS cluster created, by default there will be an OIDC issuer URL associated with it. To use the IAM role for the service account, the OIDC provider needs to exist with OIDC issuer URL. To create the OIDC provider, we will use eksctl command line utility. For the record, we should have alread done this when we created our cluster.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">eksctl utils associate-iam-oidc-provider \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">--cluster sterling \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">--approve</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-an-iam-policy">Create an IAM policy<a href="#create-an-iam-policy" class="hash-link" aria-label="Direct link to Create an IAM policy" title="Direct link to Create an IAM policy">​</a></h3><p>Create the file <code>s3-policy.json</code> with the below contents. Setting the KMS actions and key arn under <code>Resource</code> is only relevant if you are using KMS keys for bucket encryption. These Actions and Resources MUST be set if you plan on using KMS.</p><p><code>s3-policy.json</code></p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token property" style="color:#5a9bcf">&quot;Version&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;2012-10-17&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token property" style="color:#5a9bcf">&quot;Statement&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token property" style="color:#5a9bcf">&quot;Effect&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;Allow&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token property" style="color:#5a9bcf">&quot;Action&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                </span><span class="token string" style="color:#8dc891">&quot;s3:GetObject&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                </span><span class="token string" style="color:#8dc891">&quot;s3:ListBucket&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                </span><span class="token string" style="color:#8dc891">&quot;s3:PutObject&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                </span><span class="token string" style="color:#8dc891">&quot;kms:GenerateDataKey&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                </span><span class="token string" style="color:#8dc891">&quot;kms:Decrypt&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token punctuation" style="color:#8dc891">]</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token property" style="color:#5a9bcf">&quot;Resource&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                </span><span class="token string" style="color:#8dc891">&quot;arn:aws:kms:us-east-1:&lt;ACCOUNTID&gt;:key/413d348e-1307-42a7-bb92-206017e8d81c&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                </span><span class="token string" style="color:#8dc891">&quot;arn:aws:s3:::b2bis3bucket/*&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                </span><span class="token string" style="color:#8dc891">&quot;arn:aws:s3:::b2bis3bucket&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This above policy will allow acces to objects in our S3 bucket that we&#x27;ve named <code>b2bis3bucket</code>. If using KMS, you need the key that is attached to your bucket associated as a resource otherwise you will not have the permissions to run <code>kms:GenerateDataKey</code> or <code>kms:Decrypt</code>.</p><p>Now apply the policy</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">aws iam create-policy --policy-name s3-policy --policy-document file://s3-policy.json</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">{</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    &quot;Policy&quot;: {</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;PolicyName&quot;: &quot;s3-policy&quot;,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;PolicyId&quot;: &quot;ANPA24LVTCGNY64GFVKI3&quot;,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;Arn&quot;: &quot;arn:aws:iam::&lt;ACCOUNTID&gt;:policy/s3-policy&quot;,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;Path&quot;: &quot;/&quot;,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;DefaultVersionId&quot;: &quot;v1&quot;,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;AttachmentCount&quot;: 0,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;PermissionsBoundaryUsageCount&quot;: 0,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;IsAttachable&quot;: true,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;CreateDate&quot;: &quot;2023-05-11T20:01:29+00:00&quot;,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        &quot;UpdateDate&quot;: &quot;2023-05-11T20:01:29+00:00&quot;</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Make a note of the ARN value returned for the policy created.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-a-service-account">Create a service account<a href="#create-a-service-account" class="hash-link" aria-label="Direct link to Create a service account" title="Direct link to Create a service account">​</a></h3><p>Create a file <code>demo-service-account.yaml</code>. We have to create a Kubernetes service account with the name <code>demo-sa</code> in our relevant namespace using the below yaml file.</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token key atrule" style="color:#FAC863">apiVersion</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">kind</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> ServiceAccount</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token key atrule" style="color:#FAC863">metadata</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">name</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> demo</span><span class="token punctuation" style="color:#8dc891">-</span><span class="token plain">sa</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token key atrule" style="color:#FAC863">namespace</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"> sterling</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now apply the below command to create a service account.</p><p><code>kubectl apply -f demo-service-account.yaml</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-an-iam-role-and-attach-the-policy">Create an IAM Role and attach the policy<a href="#create-an-iam-role-and-attach-the-policy" class="hash-link" aria-label="Direct link to Create an IAM Role and attach the policy" title="Direct link to Create an IAM Role and attach the policy">​</a></h3><p>Using your account ID, build an arn value and add it to the OIDC provider that we retrieved above. Bear in mind that <code>&quot;system:serviceaccount:sterling:demo-sa&quot;</code> needs to have the service account name you created in case you created it with a name other than <code>demo-sa</code>. </p><p>Create the following JSON.</p><p><code>demo-role-relationship.json</code></p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token property" style="color:#5a9bcf">&quot;Version&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;2012-10-17&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token property" style="color:#5a9bcf">&quot;Statement&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      </span><span class="token property" style="color:#5a9bcf">&quot;Effect&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;Allow&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      </span><span class="token property" style="color:#5a9bcf">&quot;Principal&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token property" style="color:#5a9bcf">&quot;Federated&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;arn:aws:iam::&lt;ACCOUNT&gt;:oidc-provider/oidc.eks.us-east-1.amazonaws.com/id/9FD6ABAF8C2FCBAC9E899C79ACE7DF62&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      </span><span class="token property" style="color:#5a9bcf">&quot;Action&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;sts:AssumeRoleWithWebIdentity&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      </span><span class="token property" style="color:#5a9bcf">&quot;Condition&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token property" style="color:#5a9bcf">&quot;StringEquals&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">          </span><span class="token property" style="color:#5a9bcf">&quot;oidc.eks.us-east-1.amazonaws.com/id/9FD6ABAF8C2FCBAC9E899C79ACE7DF62:aud&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;sts.amazonaws.com&quot;</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">          </span><span class="token property" style="color:#5a9bcf">&quot;oidc.eks.us-east-1.amazonaws.com/id/9FD6ABAF8C2FCBAC9E899C79ACE7DF62:sub&quot;</span><span class="token operator" style="color:#d7deea">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;system:serviceaccount:sterling:demo-sa&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">      </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">  </span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now create the role</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">aws iam create-role </span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">--role-name s3-role </span><span class="token punctuation" style="color:#8dc891">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">--assume-role-policy-document file://demo-role-relationship.json</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token string" style="color:#8dc891">&quot;Role&quot;</span><span class="token builtin class-name" style="color:#FAC863">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string" style="color:#8dc891">&quot;Path&quot;</span><span class="token builtin class-name" style="color:#FAC863">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;/&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string" style="color:#8dc891">&quot;RoleName&quot;</span><span class="token builtin class-name" style="color:#FAC863">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;s3-role&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string" style="color:#8dc891">&quot;RoleId&quot;</span><span class="token builtin class-name" style="color:#FAC863">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;AROA24LVTCGNY4A64ECOQ&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string" style="color:#8dc891">&quot;Arn&quot;</span><span class="token builtin class-name" style="color:#FAC863">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;arn:aws:iam::&lt;ACCOUNTID&gt;:role/s3-role&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string" style="color:#8dc891">&quot;CreateDate&quot;</span><span class="token builtin class-name" style="color:#FAC863">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;2023-05-11T20:16:17+00:00&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token string" style="color:#8dc891">&quot;AssumeRolePolicyDocument&quot;</span><span class="token builtin class-name" style="color:#FAC863">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token string" style="color:#8dc891">&quot;Version&quot;</span><span class="token builtin class-name" style="color:#FAC863">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;2012-10-17&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token string" style="color:#8dc891">&quot;Statement&quot;</span><span class="token builtin class-name" style="color:#FAC863">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                    </span><span class="token string" style="color:#8dc891">&quot;Effect&quot;</span><span class="token builtin class-name" style="color:#FAC863">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;Allow&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                    </span><span class="token string" style="color:#8dc891">&quot;Principal&quot;</span><span class="token builtin class-name" style="color:#FAC863">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                        </span><span class="token string" style="color:#8dc891">&quot;Federated&quot;</span><span class="token builtin class-name" style="color:#FAC863">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;arn:aws:iam::&lt;ACCOUNTID&gt;:oidc-provider/oidc.eks.us-east-1.amazonaws.com/id/9FD6ABAF8C2FCBAC9E899C79ACE7DF62&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                    </span><span class="token string" style="color:#8dc891">&quot;Action&quot;</span><span class="token builtin class-name" style="color:#FAC863">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;sts:AssumeRoleWithWebIdentity&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                    </span><span class="token string" style="color:#8dc891">&quot;Condition&quot;</span><span class="token builtin class-name" style="color:#FAC863">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                        </span><span class="token string" style="color:#8dc891">&quot;StringEquals&quot;</span><span class="token builtin class-name" style="color:#FAC863">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#8dc891">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                            </span><span class="token string" style="color:#8dc891">&quot;oidc.eks.us-east-1.amazonaws.com/id/9FD6ABAF8C2FCBAC9E899C79ACE7DF62:aud&quot;</span><span class="token builtin class-name" style="color:#FAC863">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;sts.amazonaws.com&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                            </span><span class="token string" style="color:#8dc891">&quot;oidc.eks.us-east-1.amazonaws.com/id/9FD6ABAF8C2FCBAC9E899C79ACE7DF62:sub&quot;</span><span class="token builtin class-name" style="color:#FAC863">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">&quot;system:serviceaccount:demo-s3:demo-sa&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">                </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">            </span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">        </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token punctuation" style="color:#8dc891">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Take note of the ARN value returned for the role we created <code>arn:aws:iam::&lt;ACCOUNTID&gt;:role/s3-role</code> as we will need it below.</p><p>Attach the policy we created to the new role using the arn returned above.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">aws iam attach-role-policy \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">--role-name s3-role \</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">--policy-arn=arn:aws:iam::&lt;ACCOUNTID&gt;:policy/s3-policy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="annotate-the-service-account-with-the-iam-role">Annotate the service account with the IAM role<a href="#annotate-the-service-account-with-the-iam-role" class="hash-link" aria-label="Direct link to Annotate the service account with the IAM role" title="Direct link to Annotate the service account with the IAM role">​</a></h3><p>The service account needs to be annotated to the IAM role using the below command. This can be retrieved from the output of the role creation.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token plain">kubectl annotate serviceaccount -n sterling demo-sa eks.amazonaws.com/role-arn=arn:aws:iam::&lt;ACCOUNTID&gt;:role/s3-role</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="wrap-up">Wrap Up<a href="#wrap-up" class="hash-link" aria-label="Direct link to Wrap Up" title="Direct link to Wrap Up">​</a></h2><p>In the steps above, we have performed the following:</p><ol><li>Setup aws client</li><li>Setup <code>eskctl</code></li><li>Created a cluster</li><li>Installed <code>efs</code> storage controller</li><li>Installed <code>ebs</code> storage controller</li><li>Installed the loadbalancer controller</li><li>Installed the NGINX ingress controller</li><li>Set up the required Security policies and RBACs</li><li>Created an AWS RDS Oracle Instance and configured it</li><li>Created an S3 bucket and assigned role based authentication</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="links">Links<a href="#links" class="hash-link" aria-label="Direct link to Links" title="Direct link to Links">​</a></h2><p><a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/configuring-bucket-key.html" target="_blank" rel="noopener noreferrer">AWS Configuring Bucket Keys</a></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/ibm-client-engineering/solution-sfg-aws/tree/main/packages/create-docusaurus/templates/shared/docs/2-Prepare/Stage.md" target="_blank" rel="noreferrer noopener" class="ThemeClassNames.common.editThisPage editThisPage_U9Uk">Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/solution-sfg-aws/Prepare/organize"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Organize</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/solution-sfg-aws/category/manage"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Manage</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#software" class="table-of-contents__link toc-highlight">Software</a></li><li><a href="#helm-chart-installations" class="table-of-contents__link toc-highlight">Helm Chart installations</a></li><li><a href="#aws-account" class="table-of-contents__link toc-highlight">AWS Account</a></li><li><a href="#aws-vpc-and-eks-cluster" class="table-of-contents__link toc-highlight">AWS VPC and EKS Cluster</a><ul><li><a href="#installing-or-updating-eksctl" class="table-of-contents__link toc-highlight">Installing or updating <code>eksctl</code></a></li><li><a href="#deploying-a-cluster-with-eksctl" class="table-of-contents__link toc-highlight">Deploying a cluster with <code>eksctl</code></a></li></ul></li><li><a href="#prepare-the-cluster" class="table-of-contents__link toc-highlight">Prepare the cluster</a><ul><li><a href="#install-the-eks-helm-repo" class="table-of-contents__link toc-highlight">Install the EKS helm repo</a></li></ul></li><li><a href="#install-the-ebs-driver-to-the-cluster" class="table-of-contents__link toc-highlight">Install the EBS driver to the cluster</a><ul><li><a href="#download-the-example-ebs-iam-policy" class="table-of-contents__link toc-highlight">Download the example ebs iam policy</a></li><li><a href="#create-the-service-account" class="table-of-contents__link toc-highlight">Create the service account</a></li><li><a href="#create-the-storageclass" class="table-of-contents__link toc-highlight">Create the StorageClass</a></li></ul></li><li><a href="#prepare-efs-storage-for-the-cluster" class="table-of-contents__link toc-highlight">Prepare EFS storage for the cluster</a><ul><li><a href="#create-an-iam-policy-and-role" class="table-of-contents__link toc-highlight">Create an IAM policy and role</a></li><li><a href="#install-the-driver-add-on" class="table-of-contents__link toc-highlight">Install the driver add-on</a></li><li><a href="#create-the-filesystem" class="table-of-contents__link toc-highlight">Create the filesystem</a></li><li><a href="#create-the-mount-targets" class="table-of-contents__link toc-highlight">Create the mount targets</a></li><li><a href="#create-the-storage-classes" class="table-of-contents__link toc-highlight">Create the storage classes</a></li></ul></li><li><a href="#install-the-loadbalancer-controller" class="table-of-contents__link toc-highlight">Install the Loadbalancer controller</a><ul><li><a href="#create-the-iam-policy" class="table-of-contents__link toc-highlight">Create the IAM Policy</a></li><li><a href="#install-the-aws-load-balancer-controller" class="table-of-contents__link toc-highlight">Install the AWS Load Balancer Controller.</a></li></ul></li><li><a href="#install-the-nginx-controller" class="table-of-contents__link toc-highlight">Install the NGINX Controller</a><ul><li><a href="#get-the-nginx-controller-deployment" class="table-of-contents__link toc-highlight">Get the NGINX controller deployment</a></li><li><a href="#apply-the-deployment" class="table-of-contents__link toc-highlight">Apply the deployment</a></li><li><a href="#verify-the-deployment" class="table-of-contents__link toc-highlight">Verify the deployment</a></li></ul></li><li><a href="#security-rbacs" class="table-of-contents__link toc-highlight">Security RBACS</a></li><li><a href="#security-policies" class="table-of-contents__link toc-highlight">Security Policies</a></li><li><a href="#aws-rdsdb" class="table-of-contents__link toc-highlight">AWS RDS/DB</a><ul><li><a href="#create-the-security-group" class="table-of-contents__link toc-highlight">Create the security group</a></li><li><a href="#retrieve-the-cidr-range-for-the-cluster-vpc" class="table-of-contents__link toc-highlight">Retrieve the CIDR range for the cluster VPC</a></li><li><a href="#authorized-access-to-that-group" class="table-of-contents__link toc-highlight">Authorized access to that group</a></li><li><a href="#create-the-db-subnet-group" class="table-of-contents__link toc-highlight">Create the DB Subnet Group</a></li><li><a href="#create-the-rds-db-instance" class="table-of-contents__link toc-highlight">Create the RDS DB instance</a></li></ul></li><li><a href="#configure-the-oracle-instance" class="table-of-contents__link toc-highlight">Configure the Oracle Instance</a><ul><li><a href="#create-a-client-pod" class="table-of-contents__link toc-highlight">Create a client pod</a></li><li><a href="#connect-to-the-client-pod" class="table-of-contents__link toc-highlight">Connect to the client pod</a></li><li><a href="#configure-database" class="table-of-contents__link toc-highlight">Configure database</a></li></ul></li><li><a href="#deploy-ibm-mq-to-the-cluster" class="table-of-contents__link toc-highlight">Deploy IBM MQ to the cluster</a><ul><li><a href="#create-mq-namespace-optional" class="table-of-contents__link toc-highlight">Create MQ Namespace (optional)</a></li><li><a href="#create-an-mq-overrides-file" class="table-of-contents__link toc-highlight">Create an MQ overrides file</a></li><li><a href="#install-ibm-mq" class="table-of-contents__link toc-highlight">Install IBM MQ</a></li><li><a href="#create-the-mq-secret" class="table-of-contents__link toc-highlight">Create the MQ Secret.</a></li><li><a href="#retrieve-mqs-cluster-ip" class="table-of-contents__link toc-highlight">Retrieve MQ&#39;s cluster-ip</a></li></ul></li><li><a href="#role-based-s3-access" class="table-of-contents__link toc-highlight">Role Based S3 access</a><ul><li><a href="#bucket-creation" class="table-of-contents__link toc-highlight">Bucket Creation</a></li><li><a href="#using-kms-encryption-keys-on-s3-bucket-optional" class="table-of-contents__link toc-highlight">Using KMS Encryption keys on S3 bucket (optional)</a></li><li><a href="#create-an-oidc-provider" class="table-of-contents__link toc-highlight">Create an OIDC provider</a></li><li><a href="#create-an-iam-policy" class="table-of-contents__link toc-highlight">Create an IAM policy</a></li><li><a href="#create-a-service-account" class="table-of-contents__link toc-highlight">Create a service account</a></li><li><a href="#create-an-iam-role-and-attach-the-policy" class="table-of-contents__link toc-highlight">Create an IAM Role and attach the policy</a></li><li><a href="#annotate-the-service-account-with-the-iam-role" class="table-of-contents__link toc-highlight">Annotate the service account with the IAM role</a></li></ul></li><li><a href="#wrap-up" class="table-of-contents__link toc-highlight">Wrap Up</a></li><li><a href="#links" class="table-of-contents__link toc-highlight">Links</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Explore</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.ibm.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">IBM</a></li><li class="footer__item"><a href="https://www.ibm.com/client-engineering" target="_blank" rel="noopener noreferrer" class="footer__link-item">IBM Client Engineering - Open Solutions Library</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://ibm.com" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="https://upload.wikimedia.org/wikipedia/commons/5/51/IBM_logo.svg" alt="IBM Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo" width="150" height="150"><img src="https://upload.wikimedia.org/wikipedia/commons/5/51/IBM_logo.svg" alt="IBM Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo" width="150" height="150"></a></div></div></div></footer></div>
<script src="/solution-sfg-aws/assets/js/runtime~main.4e782439.js"></script>
<script src="/solution-sfg-aws/assets/js/main.0cd2a445.js"></script>
</body>
</html>